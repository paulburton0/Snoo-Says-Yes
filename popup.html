<!doctype html>
<html>
<!-- 
 Copyright (C) 2010  Hrishikesh Bakshi
 For permissions, check LICENSE file in this folder.
-->
<head>
<style>
body {
  min-width: 400px;
  overflow-x: hidden;
  font-family: sans-serif;
  font-size: 16px;
}

a {
    text-decoration: none;
}

a.hover {
    font-weight: bold;
}

h4 {
    padding: 0px 0px 0px 0px;
    margin: 0px 0px 5px 0px;
}

#submitnumber {
    font-size: 14px;
    font-weight: bold;
}

li {
    list-style-type: none;
    padding: 5px 5px 5px 5px;
    margin: 5px 0px 5px 0px;
    width: 400px;
    background-color: rgb(196, 224, 255);
    border-color: rgb(99, 172, 255);
}

#data {
    width: 430px;
}

.age {
    font-size: 10px;
    color: #909090;
}

.score {
    height: 100%;
    padding: 0px 7px 0px 0px;
    text-align: center;
    float: left;
    font-weight: bold;
    color: #FF8B60;
    
}

</style>
<script src="jquery.min.js" language="javascript">
</script>
<script>

var     url = chrome.extension.getBackgroundPage().selectedURL;
var   title = chrome.extension.getBackgroundPage().selectedTitle;

url = encodeURIComponent(url);
var submitUrl = "http://www.reddit.com/submit?url=" + url;
var resubmitUrl = "http://www.reddit.com/submit?resubmit=true&url=" + url;
var submitCount = 0;
var info;
var permalinks = [];
var date_now = new Date().getTime(); 
var date_entry; 
var one_day = 86400000; // milliseconds

// get URL info
function getURLInfo(url)
{
    var redditUrl = "http://www.reddit.com/api/info.json?url=" +url;
    $.getJSON(
        redditUrl,
        parseURLData
    );
}

// parse json data
function parseURLData(jsonData)
{
    submitCount=0;
    $("div#timeout").hide(0);
    var data = [ 0, "", "", "", "", "", "", "", "", url];

    for( var i=0; entry = jsonData.data.children[i]; i++) {
            submitCount +=1;
            date_entry = new Date(entry.data.created_utc*1000).getTime();
            permalinks[i] = {
                link: entry.data.permalink,
                title: entry.data.title,
                score: entry.data.score+"",
                age: Math.ceil((date_now-date_entry)/one_day),
                comments: entry.data.num_comments+"",
                subreddit: entry.data.subreddit,
            };
    }
    
    $("#data").append("<h4>"+title+"</h4>");
    if(submitCount) {
        $("#data").append("<div id=\"submission_status\"><span id=\"submitnumber\">submitted "+
                submitCount + " times | </span> <a target=\"_blank\" title=\"Post to reddit\""+
            " href=\"" + resubmitUrl + 
            "\">resubmit</a></div>");
    }
    else {
        $("#data").append("<div id=\"submission_status\"><a target=\"_blank\" title=\"Post to reddit\" href=\""+submitUrl+"\">Reddit this!</a></div>");
    }
    showLinks();
}

function showLinks() {
    if(submitCount)
    $.each(
        permalinks,
        function(index, permalink) {
            $("#links").append(
                "<li>"+ 
                "<div class=\"linkblock\"><div class=\"score\">"+permalink.score+"</div>"+
                    "<div class=\"linktext\"><a target=\"_blank\" href=\"http:\\\\www.reddit.com" +
                permalink.link + "\" title=\""+
                permalink.link + "\">"+
                permalink.title + "</a>"+
                "<div class=\"age\">"+permalink.age+ " days ago "+
                permalink.comments+" comments r/"+permalink.subreddit+
                "</div></div></div>"+
                "</li>"
            );
        }
    );
}

</script>
</head>
<body>
    <div id="data">
    </div>
    <div id="links">
    </div>
    <div id="timeout">
        Loading... please wait.
    </div>
    <script type="text/javascript">
    getURLInfo(url);
    </script>
</body>
</html>
